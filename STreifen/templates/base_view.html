{% extends "base.html" %}

{% block title %}
<title>{{obj.object_type.name|capfirst}}:{{obj.name}}</title>
{% endblock %}

{% block datatableslib %}{% endblock %}
{% block visjslib %}{% endblock %}

{% block jquery %}
<link rel="stylesheet" type="text/css" href="/static/stixviz/app.css" /> 
<script>
function detachObject(){
    var id = [];
    $("input.object_id:checked").each(function(){
        id.push($(this).val());
    });
    if(id){
        $.ajax({
            type: 'POST',
            data: {
                detach: id,
                csrfmiddlewaretoken:'{{csrf_token}}',
            },
            success: function(html){
                setTimeout(function(html){
                    location.reload(true);
                },1000);
            }
        });
    };
};
$(document).ready(
    function(){
        $("select#id_relation").change(function(){
            var parent = $(this).parent();
            console.log(parent);
            var data = {
                csrfmiddlewaretoken:'{{csrf_token}}',
            };
            if (parent.is("div#select_rel")){
                data["select_rel"] = $(this).val();
            } else if (parent.is("div#select_dr")){
                data["select_dr"] = $(this).val();
            };
            $.ajax({
                type: 'POST',
                //data: {select_rel:$(this).val(),csrfmiddlewaretoken:'{{csrf_token}}'},
                data: data,
                success: function(result){
                    //console.log(parent);
                    if (parent.is("div#select_rel")){
                        rform = $(result).find("#add_obj");
                        $("#add_obj").replaceWith(rform);
                    }else if (parent.is("div#select_dr")){
                        cform = $(result).find("#create_object");
                        $("#create_object").replaceWith(cform);
                    };
                }
            });
        });
        $("select#id_type").change(function(){
            var parent = $(this).parent();
            $.ajax({
                type: 'POST',
                data: {
                    select:$(this).val(),
                    csrfmiddlewaretoken:'{{csrf_token}}',
                },
                success: function(result){
                    if (parent.is("div#select_create")){
                        cform = $(result).find("#create_object");
                        $("#create_object").replaceWith(cform);
                    }else if (parent.is("div#select_rel")){
                        aform = $(result).find("#add_obj");
                        $("#add_obj").replaceWith(aform);
                    }else if (parent.is("div#select_type")){
                        aform = $(result).find("#add_obj");
                        console.log(aform);
                        $("#add_obj").replaceWith(aform);
                    }else if (parent.is("div#select_bulk")){
                        bform = $(result).find("#bulk_create");
                        $("#bulk_create").replaceWith(bform);
                    }else if (parent.is("div#filter")){
                        table = $(result).find("tbody#objects_table");
                        console.log(table);
                        $("tbody#objects_table").replaceWith(table);
                    };
                }
            });
        });
        $('#id_published').datetimepicker({format:'Y-m-d H:i'});
        $('#id_first_seen').datetimepicker({format:'Y-m-d H:i'});
        $('#id_last_seen').datetimepicker({format:'Y-m-d H:i'});
        Tablesort(document.getElementById('obj_table'));
        Tablesort(document.getElementById('rel_table'));
        Tablesort(document.getElementById('sight_table'));
    }
);
</script>
{% endblock%}

{% block container %}

{% block modal_delete %}
<div class="modal" id="delete_form" role="dialog">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">&times;</button>
<h4 class="modal-title">Delete</h4>
</div>
<div class="modal-body">
<h3>Are you sure?</h3>
<form method="post">{% csrf_token %}
<input class="btn btn-xs btn-danger" type="submit" name="delete" value="Yes, Delete">
<button class="btn btn-md btn-primary" data-dismiss="modal">No, Close</button>
</form>
</div><!--/.modal-body-->
</div><!--/.modal-content-->
</div><!--/.modal-dialog-->
</div><!--/.modal-->
{% endblock %}

{% block modal_bulk %}
<div class="modal" id="bulk_form" role="dialog">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">&times;</button>
<h4 class="modal-title">Bulk Create</h4>
</div>
<div class="modal-body">
<form method="post">{% csrf_token %}
<div id="select_bulk">{{soform.as_table}}</div>
<div id="bulk_create">{{obform}}</div>
{{bform}}
<input class="btn btn-primary btn-sm" type="submit" name="create_bulk" value="Create">
</form>
</div><!--/.modal-body-->
</div><!--/.modal-content-->
</div><!--/.modal-dialog-->
</div><!--/.modal-->
{% endblock %}


{% block modal_add %}
<div class="modal" id="add_form" role="dialog">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">&times;</button>
<h4 class="modal-title">Add Object</h4>
</div>
<div class="modal-body">
<form class="add_form" method="post">{% csrf_token %}
{% if obj.object_type.name == "identity" %}
<table class="table">
<th>Where Sighted</th><td>{{obj.object_type.name|capfirst}}:{{obj.name}}</td>
{{aoform.as_table}}
</table>
<input class="btn btn-primary btn-sm" type="submit" name="add_sight" value="Add">
{% else %}
{% if obj.object_type.name != "report" %}
<div id="select_rel" >
{{obj.object_type.name|capfirst}}:{{obj.name}}
{{aoform.relation}}
{% elif obj.object_type.name == "report" %}
<div id="select_type">
{{soform}}
{% endif %}
<div id="add_obj" >
{{aoform.objects}}
</div>
<input class="btn btn-primary btn-sm" type="submit" name="add_obj" value="Add">
</div>
{% endif %}
</form>
</div><!--/.modal-body-->
</div><!--/.modal-content-->
</div><!--/.modal-dialog-->
</div><!--/.modal-->
{% endblock %}

{% block modal_create %}
<div class="modal" id="create_form" role="dialog">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">&times;</button>
<h4 class="modal-title">Create Object</h4>
</div>
<div class="modal-body">
<form class="create_form" method="post">{% csrf_token %}
{% if obj.object_type.name == "report" %}
<div id="select_create">{{soform}}</div>
{% else %}
<div id="select_dr">{{drform}}</div>
{% endif %}
<br>
<div id="create_object" >
{% if coform %}
<table class="table">
{{coform.as_table}}
</table>
<input class="btn btn-info btn-sm" type="submit" name="create_obj" value="Create">
{% endif %}
</div><!--/#create_form-->
</form>
</div><!--/.modal-body-->
</div><!--/.modal-content-->
</div><!--/.modal-dialog-->
</div><!--/.modal-->
{% endblock %}

{% block modal_edit %}
<div class="modal" id="obj_form" role="dialog">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">&times;</button>
<h4 class="modal-title">Edit</h4>
</div>
<div class="modal-body">
<form class="create_form" method="post">{% csrf_token %}
<table class="table">
{{form.as_table}}
</table>
<input class="btn btn-primary btn-sm" type="submit" name="update" value="Update">
</form>
</div><!--/.modal-body-->
</div><!--/.modal-content-->
</div><!--/.modal-dialog-->
</div><!--/.modal-->
{% endblock %}

<div id="canvas-container" class="hidden">

<div class="panel panel-default">
<div class="panel-heading">
<h1 id="header" style="cursor:pointer;">Visualize</h1>
</div>

<div class="panel-body">

<div id="canvas-wrapper"><svg id="canvas"></svg></div>

<div id="legend" class="sidebar">
<h2>Legend</h2>
<ul id="legend-content"></ul>
</div>

<div id="selected" class="sidebar">
<h2>Selected Node</h2>
<div id="selection"></div>
</div><!--/#selected-->

</div><!--/.panel-body-->
</div><!--/.panel-->
</div><!--/#canvas-container-->



{% block left_pane %}
<div id="view" class="col-md-6">

<div id="obj_panel" class="panel panel-default">
<div class="panel-heading">
<a data-toggle="collapse" href="#obj_body" >
{{obj.object_type.name|capfirst}}▼</a>
<a class="btn btn-warning btn-xs" data-toggle="modal" href="#obj_form">Edit</a>
<a class="btn btn-danger btn-xs" data-toggle="modal" href="#delete_form">Delete</a>
<br>
<h4>
<a href="">
{% if obj.name %}{{obj.name}}
{% else %}{{obj.object_id.object_id}}
{% endif %}
</a>
<br>
</h4>
</div><!--.panel-heading-->

<div id="obj_body" class="panel-collapse in">
<!--<div id="obj_body" class="panel-collapse collapse ">-->

<div class="panel-body">

<table class="table table-condensed">
{% block property %}
<tr><th class="col-md-3">Created</th><td>{{obj.created}}</td></tr>
<tr><th >Modified</th><td>{{obj.modified}}</td></tr>
<tr><th >Labels</th>
<td>
{% for l in obj.labels.all %}
{{l.value}}<br>
{% endfor %}
</td></tr>
{% if obj.object_type.name == "report"%}
<tr><th >Publisher</th><td>{{obj.created_by_ref}}</td></tr>
<tr><th >Published</th><td>{{obj.published}}</td></tr>
{% elif obj.object_type.name == "identity"%}
<tr><th >Sectors</th><td>{% for s in obj.sectors.all %}{{s}}<br>{% endfor%}</td></tr>
{% elif obj.object_type.name == "threat-actor" or obj.object_type.name == "campaign" %}
<tr><th >Alias</th><td>{% for a in obj.aliases.all %}{{a}}<br>{% endfor%}</td></tr>
{% endif %}
{% endblock %}

<tr>
<th class="col-md-3">Description</th>
<td><pre>{{obj.description}}</pre></td>
</tr>
</table>

</div><!--/.panel-body-->
</div><!--/.collapse-->
</div><!--/.panel-->


<div id="stix_panel" class="panel panel-default">
<div class="panel-heading">
<a data-toggle="collapse" href="#stix_body" >
▼</a>
STIX
<a class="btn btn-default btn-xs" href="/stix/{{obj.object_id.object_id}}.json">Full</a>
<button class="btn btn-default btn-xs" id="viz" onclick=toggleViz("stixtext")>Visualize</button>
<a class="btn btn-default btn-xs" href="/timeline/{{obj.object_id.object_id}}">Timeline</a>
</div>
<div id="stix_body" class="panel-collapse in">
<div class="panel-body">
<textarea id="stixtext" read-only style="height:500px;">{{stix}}</textarea>
</div><!--/.panel_body-->
</div><!--/#stix_body-->
</div><!--/#stix_panel-->

</div>
{% endblock %}
{% block right_pane %}
<div class="col-md-6">


<ul class="nav nav-pills">
<li class="active"><a data-toggle="tab" href="#obj_tab">Objects</a></li>
<li ><a data-toggle="tab" href="#rel_tab">Relations</a></li>
<li><a data-toggle="tab" href="#sight_tab">Sightings</a></li>
{% if obj.object_type.name == "indicator" %}
<li><a data-toggle="tab" href="#pattern_tab">Patterns</a></li>
{% elif obj.object_type.name == "report" %}
<li><a data-toggle="tab" href="#objrefs_tab">Object Refs</a></li>
{% endif %}
</ul>
<div class="panel panel-primary">
<div class="panel-body">
<a class="btn btn-primary btn-xs" data-toggle="modal" href="#add_form">Add</a>
{% if obj.object_type.name != "identity" %}
<a class="btn btn-info btn-xs" data-toggle="modal" href="#create_form">Create</a>
<a class="btn btn-info btn-xs" data-toggle="modal" href="#bulk_form">Bulk Create</a>
{% endif %}
<a class="btn btn-warning btn-xs" onclick=detachObject()>Detach</a>

<div class="tab-content">

{% if obj.object_type.name == "report" %}
<div class="tab-pane" id="objrefs_tab" >
<table id="objrefs_table" class="table table-condensed table-stripe table-hover display" width="100%">
<thead><tr>
<th class="col-sm-1"> </th>
<th >Object</th>
</tr></thead>
<tbody >
{% for r in obj.object_refs.all %}
<tr>
<td><input class="object_id" type="checkbox" value="{{r.object_id}}"></td>
<td><a href="/stix/{{r.object_id}}">{{r}}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}


<div class="tab-pane" id="sight_tab" >
<table id="sight_table" class="table table-condensed table-stripe table-hover display" width="100%">
<thead><tr>
<th class="col-sm-1"> </th>
<th class="col-sm-3">Where Sighted</th>
<th class="col-sm-3">Sighting of</th>
<th data-sort-default class="col-sm-5">First/Last Seen</th>
</tr></thead>
<tbody id="sight_tbody">
{% for s in sights %}
<tr>
<td>
<a class="btn btn-default btn-xs" href="/stix/{{s.object_id.object_id}}">></a>
<input class="object_id" type="checkbox" value="{{s.object_id.object_id}}">
</td>
<td>
<!--<td><a class="btn btn-primary btn-xs">{{s.id}}</a></td>-->
{% for r in s.where_sighted_refs.all %}
{% for o in objects %}
{% ifequal o.object_id r %}
<a href="/stix/{{o.object_id.object_id}}">
<span class="label label-default">{{o.object_type.name}}</span><br>
{{o.name}}</a><br>
{% endifequal %}
{% endfor %}
{% endfor %}
</td>
<td>
{% for o in objects %}
{% ifequal o.object_id s.sighting_of_ref %}
<a href="/stix/{{o.object_id.object_id}}">
<span class="label label-default">{{o.object_type.name}}</span><br>
{{o.name}}</a><br>
{% endifequal %}
{% endfor %}
</td>
<!--<td>{{s.object_id.object_id}}</td>-->
<td>{{s.first_seen|date:"c"}}
- {{s.last_seen|date:"c"}}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div><!--/#sightings-->

<div class="tab-pane " id="rel_tab" >
<table id="rel_table" class="table table-condensed table-stripe table-hover display" width="100%">
<thead><tr>
<th class="col-sm-1"> </th>
<th class="col-sm-3">Source</th>
<th data-sort-default class="col-sm-2">Type</th>
<th class="col-sm-3">Target</th>
<th class="col-sm-3">Description</th>
</tr></thead>
<tbody id="rel_tbody">
{% for r in rels %}
<tr>
<td>
<!--<a class="btn btn-default btn-xs" href="/stix/{{r.object_id.object_id}}">></a>-->
<input class="object_id" type="checkbox" value="{{r.object_id.object_id}}">
</td>
<td>
{% for s in objects %}
{% if s.object_id == r.source_ref %}
<span class="label label-default">{{s.object_type.name}}</span><br>
<a href="/stix/{{s.object_id.object_id}}">{{s.name}}</a>
{% endif %}
{% endfor %}
</td>
<td style="vertical-align:middle">
<!--<span class="label label-info">{{r.relationship_type.name}}</span>-->
<a href="/stix/{{r.object_id.object_id}}">
{{r.relationship_type.name}}
</a>
</td>
<td>
{% for t in objects %}
{% if t.object_id == r.target_ref %}
<span class="label label-default">{{t.object_type.name}}</span><br>
<a href="/stix/{{t.object_id.object_id}}">{{t.name}}</a>
{% endif %}
{% endfor %}
</td>
<td>
{{r.description}}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div><!--/#relations-->

<div class="tab-pane active" id="obj_tab" >

<table id="obj_table" class="table table-condensed table-stripe table-hover display" width="100%">
<thead><tr>
<!--
<th class="col-sm-2">
<form>{% csrf_token %}
<div id="filter">Type:{{soform.type}}</div>
</form>
</th>
-->
<th data-sort-default class="col-sm-4">Type</th>
<th class="col-sm-4">Name</th>
<th class="col-sm-4">Label</th>
</tr></thead>
<tbody >
{% for o in objects %}
<tr>
<td>{{o.object_type.name}}</td>
<td><a href="/stix/{{o.object_id.object_id}}">{{o.name}}</a></td>
<td>{% for l in o.labels.all %}{{l}}<br>{% endfor %}</td>
<!--<td>{{o.object_id.object_id}}</td>-->
</tr>
{% endfor %}
</tbody>
</table>
</div><!--/#objects-->

</div><!--/tab-content-->

</div><!--/.panel-body-->
</div><!--/.panel-->

</div><!--/tables-->

</div>

{% endblock %}

{% block stixvizlib %}
<script type="text/javascript" src="/static/d3/d3.min.js"></script>
<script type="text/javascript" src="/static/stixviz/stix2viz.js"></script>
<script type="text/javascript" src="/static/stixviz/app.js"></script>
{% endblock %}


{% endblock %}
