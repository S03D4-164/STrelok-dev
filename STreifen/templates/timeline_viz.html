{% extends "base.html" %}

{% block title %}
<title>Timeline</title>
{% endblock %}

{% block datatableslib %}{% endblock %}
{% block jquery %}
<style>
{% for k,v in color.items %}
.vis-item.{{k}} {
  background-color: {{v}};
}
{% endfor%}
</style>
{% endblock %}


{% block container %}

<div class="col-md-12">
<div class="panel panel-default">
<div class="panel-heading">Timeline{% if obj %} of <a href="/stix/{{obj.object_id.object_id}}">{{obj}}</a>{% endif %}</div>
<div class="panel-body">

<div class="col-md-10" id="visualization" >
</div>

<div class="col-md-2">
<div class="btn-group-vertical">
<input class="btn"  type="button" id="zoomIn" value="Zoom in"/>
<input class="btn" type="button" id="zoomOut" value="Zoom out"/>
<input class="btn" type="button" id="moveLeft" value="Move left"/>
<input class="btn" type="button" id="moveRight" value="Move right"/>
</div>
<h4>Legend</h4>
{% for k,v in color.items %}
<input class="legend" id="{{k}}" type="checkbox" value="{{k}}" checked>
<span style="color:{{v}}">â– </span>: {{k}}<br>
{% endfor %}
<hr>
<form method=post>{% csrf_token %}
<div id="types_form">
{{form.as_p}}
</div>
</form>
</div>

</div><!--/panel-body-->
</div><!--/panel-->
</div>

<script type="text/javascript">
{% if groups %}
var groups = new vis.DataSet();
groups.add([{% for g in groups %}
{
    id: "{{g.id}}",
    content: "{{g.content}}",
    nestedGroups: [{% for n in g.nested_groups%}"{{n}}",{% endfor %}],
},
{% endfor %}]);
{% endif %}

{% if subgroups %}
groups.add([{% for g in subgroups %}
{
    id: "{{g.id}}",
    content: "{{g.content}}",
},
{% endfor %}]);
{% endif %}

var items = new vis.DataSet();
items.add([{% for i in items %}
{% if i.group %}
{
    id: "{{i.id}}",
    content: "{{i.content}}",
    title: "{{i.title}}",
    group: "{{i.group}}",
    subgroup: "{{i.subgroup}}",
    className: "{{i.className}}",
    start: "{{i.start}}",
    {% if i.end %}end: "{{i.end}}",{% endif %}
},
{% endif %}
{% endfor %}]);

var container = document.getElementById('visualization');
var options = {
    align: 'left',
    orientation: 'top',
    type: 'point',
    //horizontalScroll:true,
};
{% if groups %}
var timeline = new vis.Timeline(container, items, groups, options);
{% else %}
var timeline = new vis.Timeline(container, items, options);
{% endif %}

function move (percentage) {
    var range = timeline.getWindow();
    var interval = range.end - range.start;
    timeline.setWindow({
        start: range.start.valueOf() - interval * percentage,
        end:   range.end.valueOf()   - interval * percentage
    });
}
document.getElementById('zoomIn').onclick    = function () { timeline.zoomIn( 0.2); };
document.getElementById('zoomOut').onclick   = function () { timeline.zoomOut( 0.2); };
document.getElementById('moveLeft').onclick  = function () { move(0.2); };
document.getElementById('moveRight').onclick  = function () { move(-0.2); };
document.getElementById('id_type').onchange = function () {
    timeline.setOptions({type:this.value});
};

$('input.legend').click(function() {
checked = $(this).prop("checked");
var c = $(this).attr("id");
var item = items.get()
for (var i in item){
    j = item[i]["id"];
    k = items.get(j);
    if (k["className"]==c){
        if (checked==true){
            items.update({id:j,style:"visibility:visible"});
        }else {
            items.update({id:j,style:"visibility:hidden"});
        };
    };
};
});
$('#id_group input').click(function() {
checked = $(this).prop("checked");
var t = $(this).parent().text().replace(/^\s+/, "");
var g = groups.get(t);
for (var i in g["nestedGroups"]){
    var j = groups.get(g["nestedGroups"][i])
    groups.update({id:j["id"], visible:checked});
}
groups.update({id:g["id"], visible:checked});
});
</script>
</div>
{% endblock%}
